---
title: "ANOVA using Python"
date:   2018-10-22 06:18:08
author_profile: true
permalink: blog/anova.html
classes: wide
---
<p>
{% include  share.html %}
</p>

## <span style="color:#33a8ff">What is ANOVA (ANalysis Of VAriance)?</span>
 - used to compare the means of more than 2 groups (t-test can be used to compare 2 groups)
 - groups mean differences inferred by analyzing variances
 - Main types: One-way (one factor) and two-way (two factors) ANOVA (factor is an independent variable)
 
 Note: In ANOVA, group, factors, and independent variables are similar terms
 
### ANOVA Hypotheses
 - <i>Null hypotheses</i>: Groups means are equal (no variation in means of groups)
 - <i>Alternative hypotheses</i>: At least, one group mean is different from other groups
 
### ANOVA Assumptions
 - Residuals (experimental error) are normally distributed (Shapiro-Wilks Test)
 - Homogeneity of variances (variances are equal between treatment groups) (Levene or Bartlett Test)
 - Observations are sampled independently from each other
 
### How ANOVA works?
 - Check sample sizes: equal number of observation in each group
 - Calculate Mean Square for each group (MS) (SS of group/level-1);
   level-1 is a degree of freedom (df) for a group
 - Calculate Mean Square error (MSE) (SS error/df of residuals)
 - Calculate F-value (MS of group/MSE) 
 
## <span style="color:#33a8ff">One-way (one factor) ANOVA with Python</span>  

Example data for one-way ANOVA analysis tutorial, [dataset]({{"/assets/posts/anova/onewayanova.txt" | absolute_url }})

| A  | B  | C  | D  |
|----|----|----|----|
| 25 | 45 | 30 | 54 |
| 30 | 55 | 29 | 60 |
| 28 | 29 | 33 | 51 |
| 36 | 56 | 37 | 62 |
| 29 | 40 | 27 | 73 |

Here, there are four treatments (A, B, C, and D), which are groups for ANOVA analysis. Treatments are independent 
variable and termed as factor. As there are four types of treatments, treatment factor has four levels. 

For this experimental design, there is only factor (treatments) or independent variable to evaluate, and therefore, 
one-way ANOVA method is suitable for analysis.

Useful reading: [Data handling using pandas ]({{"/blog/pandas.html" | absolute_url }})

```python
# I am using Python 3
# load packages
import pandas as pd
# load data file
d = pd.read_csv("https://reneshbedre.github.io/assets/posts/anova/onewayanova.txt", sep="\t")
# generate a boxplot to see the data distribution by treatments. Using boxplot, we can easily detect the differences 
# between different treatments
d.boxplot(column=['A', 'B', 'C', 'D'], grid=False)
```

![screenshot]({{ "/assets/posts/anova/onewaynova_boxplot.png" | absolute_url }})


```python
# load packages
import scipy.stats as stats
# stats f_oneway functions takes the groups as input and returns F and P-value
fvalue, pvalue = stats.f_oneway(d['A'], d['B'], d['C'], d['D'])
print(fvalue, pvalue)
# 17.492810457516338 2.639241146210922e-05

# get ANOVA table as R like output
import statsmodels.api as sm
from statsmodels.formula.api import ols
# reshape the d dataframe suitable for statsmodels package 
d_melt = pd.melt(d.reset_index(), id_vars=['index'], value_vars=['A', 'B', 'C', 'D'])
# replace column names
d_melt.columns = ['index', 'treatments', 'value']
# Ordinary Least Squares (OLS) model
model = ols('value ~ C(treatments)', data=d_melt).fit()
anova_table = sm.stats.anova_lm(model, typ=2)
anova_table
# output
                sum_sq    df         F    PR(>F)
C(treatments)  3010.95   3.0  17.49281  0.000026
Residual        918.00  16.0       NaN       NaN

# ANOVA table using bioinfokit v1.0.3 or later (it uses wrapper script for anova_lm)
from bioinfokit.analys import stat
res = stat()
res.anova_stat(df=d_melt, res_var='value', anova_model='value ~ C(treatments)')
res.anova_summary
# output
                 df   sum_sq   mean_sq         F    PR(>F)
C(treatments)   3.0  3010.95  1003.650  17.49281  0.000026
Residual       16.0   918.00    57.375       NaN       NaN

# note: if the data is balanced (equal sample size for each group), Type 1, 2, and 3 sums of squares
# (typ parameter) will produce similar results.
```

### Interpretation
The P-value obtained from ANOVA analysis is significant (P<0.05), and therefore, we conclude 
that there are significant differences among treatments.

<p style="background-color: #ddf3f5; padding: 20px;"><b>Note</b>:  If you have unbalanced (unequal sample size for each
 group) data, you can perform similar steps as described for one-way ANOVA with balanced design (equal sample size for 
 each group).</p>

From ANOVA analysis, we know that treatment differences are statistically significant, but ANOVA does not tell which 
treatments are significantly different from each other. To know the pairs of significant different treatments, we
will perform multiple pairwise comparison (<b>Post-hoc comparison</b>) analysis using <b>Tukey HSD</b> test.

```python
# we will use bioinfokit (v1.0.1 or later) for performing tukey HSD test
# check documentation here https://reneshbedre.github.io/blog/howtoinstall.html
from bioinfokit.analys import stat
# perform multiple pairwise comparison (Tukey HSD)
# unequal sample size data, tukey_hsd uses Tukey-Kramer test
res = stat()
res.tukey_hsd(df=d_melt, res_var='value', xfac_var='treatments', anova_model='value ~ C(treatments)')
res.tukey_summary
# output
  group1 group2  Diff      Lower      Upper   q-value   p-value
0      A      B  15.4   1.692871  29.107129  4.546156  0.025070
1      A      C   1.6 -12.107129  15.307129  0.472328  0.900000
2      A      D  30.4  16.692871  44.107129  8.974231  0.001000
3      B      C  13.8   0.092871  27.507129  4.073828  0.048178
4      B      D  15.0   1.292871  28.707129  4.428074  0.029578
5      C      D  28.8  15.092871  42.507129  8.501903  0.001000
```


Above results from Tukey HSD suggests that except A-C, all other pairwise comparisons for treatments rejects null 
hypothesis (P-tukey<0.05) and indicates statistical significant differences.

<p style="background-color: #ddf3f5; padding: 20px;"><b>Note</b>:  Tukey test is highly conservative. If you have 
large number comparisons (say > 10 or 20) to make using Tukey, there may be chances that you may not get significant 
results for all or expected pairs. If you are interested in only specific or few comparisons and you won't find 
significant differences using Tukey, you may split the data for specific comparisons or use t-test</p> 

 
### Test ANOVA assumptions

- ANOVA assumptions can be checked using test statistics (e.g. Shapiro-Wilk, Bartlett, levene test) and the visual 
  approaches such as residual plots (e.g. QQ-plots) 
- The visual approaches performs better than statistical tests. For example, Shapiro-Wilk test have low power for small 
  sample size data and deviate significantly from normality for large sample sizes.

Now, I will generate QQ-plot from standardized residuals (outliers can be easily detected from standardized residuals
than normal residuals)

```python
import statsmodels.api as sm
import matplotlib.pyplot as plt
# res.anova_std_residuals are standardized residuals obtained from ANOVA (check above)
sm.qqplot(res.anova_std_residuals, line='45')
plt.xlabel("Theoretical Quantiles")
plt.ylabel("Standardized Residuals")
plt.show()
```

<p align="center">
<img src="/assets/posts/anova/qq.svg" width="600">
</p>

As the standardized residuals lie around the 45-degree line, it suggests that the residuals are normally distributed

<b>Shapiro-Wilk test</b> can be used to check the <b> normal distribution of residuals </b>. <i>Null hypothesis</i>: 
data is drawn from normal distribution.

```python
# load packages
import scipy.stats as stats
w, pvalue = stats.shapiro(model.resid)
print(w, pvalue)
# 0.9685019850730896 0.7229772806167603
```

As the P-value is non significant, we fail to reject null hypothesis and
conclude that data is drawn from normal distribution.

As the data is drawn from normal distribution, use Bartlett’s test 
to check the <b>Homogeneity of variances</b>.
 <i>Null hypothesis</i>: samples from populations 
have equal variances.

```python
# load packages
import scipy.stats as stats
w, pvalue = stats.bartlett(d['A'], d['B'], d['C'], d['D'])
print(w, pvalue)
5.687843565012841 0.1278253399753447
```
As the P-value (0.12) is non significant, we fail to reject null 
hypothesis and conclude that treatments have equal variances.

<b>Levene test</b> can be used to check the Homogeneity of variances
when the data is not drawn from normal distribution.

<!--
```python
# load packages
import scipy.stats as stats
w, pvalue = stats.levene(d['A'], d['B'], d['C'], d['D'])
print(w, pvalue)
# 1.9219593192195938 0.16673281219949276
```
-->


**<span style="color:#33a8ff">Two-way (two factor) ANOVA with Python</span>**  

Example data for two-way ANOVA analysis tutorial, [dataset]({{"/assets/posts/anova/twowayanova.txt" | absolute_url }})

From dataset, there are two factors (independent variables) viz. genotypes and yield in years. Genotypes and years has 
five and three levels respectively (see one-way ANOVA to know factors and levels).

For this experimental design, there are two factors to evaluate, and therefore, two-way ANOVA method is suitable for analysis. 
Here, using two-way ANOVA, we can simultaneously evaluate how type of genotype and years affects the yields of plants. If
you apply one-way ANOVA here, you can able to evaluate only one factor at a time. 

From two-way ANOVA, we can tests three hypotheses 1) effect of genotype on yield 2) effect of time (years) on yield, and
3) effect of genotype and time (years) interactions on yield

```python
# load packages
import pandas as pd
import seaborn as sns
# load data file
d = pd.read_csv("https://reneshbedre.github.io/assets/posts/anova/twowayanova.txt", sep="\t")
# reshape the d dataframe suitable for statsmodels package 
# you do not need to reshape if your data is already in stacked format. Compare d and d_melt tables for detail 
# understanding 
d_melt = pd.melt(d, id_vars=['Genotype'], value_vars=['1_year', '2_year', '3_year'])
# replace column names
d_melt.columns = ['Genotype', 'years', 'value']
d_melt.head()
# output
  Genotype   years  value
0        A  1_year   1.53
1        A  1_year   1.83
2        A  1_year   1.38
3        B  1_year   3.60
4        B  1_year   2.94

# generate a boxplot to see the data distribution by genotypes and years. Using boxplot, we can easily detect the 
# differences between different groups
sns.boxplot(x="Genotype", y="value", hue="years", data=d_melt, palette="Set3") 
```

![screenshot]({{ "/assets/posts/anova/twowayanova_boxplot.png" | absolute_url }})

```python
# load packages
import statsmodels.api as sm
from statsmodels.formula.api import ols
# Ordinary Least Squares (OLS) model
# C(Genotype):C(years) represent interaction term
model = ols('value ~ C(Genotype) + C(years) + C(Genotype):C(years)', data=d_melt).fit()
anova_table = sm.stats.anova_lm(model, typ=2)
anova_table
# output
                          sum_sq    df           F        PR(>F)
C(Genotype)            58.551733   5.0   32.748581  1.931655e-12
C(years)              278.925633   2.0  390.014868  4.006243e-25
C(Genotype):C(years)   17.122967  10.0    4.788525  2.230094e-04
Residual               12.873000  36.0         NaN           NaN
```

<b>Interpretation</b>: The P-value obtained from ANOVA analysis for genotype, years, and interaction are statistically 
significant (P<0.05). We conclude that type of genotype significantly affects the yield outcome, time (years) 
significantly affects the yield outcome, and interaction of both genotype and time (years) significantly affects the 
yield outcome.

<p style="background-color: #ddf3f5; padding: 20px;"><b>Note</b>: If you have unbalanced (unequal sample size for each group) data, you can perform similar steps as described
for two-way ANOVA with the balanced design but set `typ=3`. Type 3 sums of squares (SS) is recommended for an unbalanced
design for multifactorial ANOVA.</p>

Now, we know that genotype and time (years) differences are statistically significant, but ANOVA does not tell which 
genotype and time (years) are significantly different from each other. To know the pairs of significant different 
genotype and time (years), perform multiple pairwise comparison (<b>Post-hoc comparison</b>) analysis using 
<b>Tukey HSD</b> test.

```python
# we will use bioinfokit (v1.0.1 or later) for performing tukey HSD test
# check documentation here https://reneshbedre.github.io/blog/howtoinstall.html
from bioinfokit.analys import stat
# perform multiple pairwise comparison (Tukey HSD)
# unequal sample size data, tukey_hsd uses Tukey-Kramer test
res = stat()
# for main effect Genotype
res.tukey_hsd(df=d_melt, res_var='value', xfac_var='Genotype', anova_model='value ~ C(Genotype) + C(years) + C(Genotype):C(years)')
res.tukey_summary
# output
   group1 group2      Diff     Lower     Upper    q-value   p-value
0       A      B  2.040000  1.191912  2.888088  10.234409  0.001000
1       A      C  2.733333  1.885245  3.581421  13.712771  0.001000
2       A      D  2.560000  1.711912  3.408088  12.843180  0.001000
3       A      E  0.720000 -0.128088  1.568088   3.612145  0.135306
4       A      F  2.573333  1.725245  3.421421  12.910072  0.001000
5       B      C  0.693333 -0.154755  1.541421   3.478361  0.163609
6       B      D  0.520000 -0.328088  1.368088   2.608771  0.453066
7       B      E  1.320000  0.471912  2.168088   6.622265  0.001000
8       B      F  0.533333 -0.314755  1.381421   2.675663  0.425189
9       C      D  0.173333 -0.674755  1.021421   0.869590  0.900000
10      C      E  2.013333  1.165245  2.861421  10.100626  0.001000
11      C      F  0.160000 -0.688088  1.008088   0.802699  0.900000
12      D      E  1.840000  0.991912  2.688088   9.231036  0.001000
13      D      F  0.013333 -0.834755  0.861421   0.066892  0.900000
14      E      F  1.853333  1.005245  2.701421   9.297928  0.001000

# for main effect years
res.tukey_hsd(df=d_melt, res_var='value', xfac_var='years', anova_model='value ~ C(Genotype) + C(years) + C(Genotype):C(years)')
res.tukey_summary
# output
   group1  group2      Diff     Lower     Upper    q-value  p-value
0  1_year  2_year  2.146667  1.659513  2.633821  15.230432    0.001
1  1_year  3_year  5.521667  5.034513  6.008821  39.175794    0.001
2  2_year  3_year  3.375000  2.887846  3.862154  23.945361    0.001

# for interaction effect between genotype and years
res.tukey_hsd(df=d_melt, res_var='value', xfac_var=['Genotype','years'], anova_model='value ~ C(Genotype) + C(years) + C(Genotype):C(years)')
res.tukey_summary.head()
# output
        group1       group2  Diff     Lower     Upper   q-value   p-value
0  (1_year, A)  (1_year, B)  1.94  0.108861  3.771139  5.619190  0.028673
1  (1_year, A)  (1_year, C)  2.32  0.488861  4.151139  6.719856  0.003465
2  (1_year, A)  (1_year, D)  2.07  0.238861  3.901139  5.995734  0.014276
3  (1_year, A)  (1_year, E)  0.34 -1.491139  2.171139  0.984807  0.900000
4  (1_year, A)  (1_year, F)  2.88  1.048861  4.711139  8.341890  0.001000
```

Similar to one-way ANOVA, you can use <b>Levene</b> and <b>Shapiro-Wilk test</b> to validate the assumptions for
homogeneity of variances and normal distribution of residuals.

**<span style="color:#33a8ff">Additional Notes</span>**  
- three factor designs can be analyzed in a similar way to two-way ANOVA

**<span style="color:#060606">References</span>**
- Seabold, Skipper, and Josef Perktold. “statsmodels: Econometric and statistical modeling with python.” 
  Proceedings of the 9th Python in Science Conference. 2010.
- Virtanen P, Gommers R, Oliphant TE, Haberland M, Reddy T, Cournapeau D, Burovski E, Peterson P, Weckesser W, Bright J, 
  van der Walt SJ. SciPy 1.0: fundamental algorithms for scientific computing in Python. Nature methods. 2020 
  Mar;17(3):261-72.  
- Mangiafico, S.S. 2015. An R Companion for the Handbook of Biological Statistics, version 1.3.2. 
- Vallat, R. (2018). Pingouin: statistics in Python. Journal of Open Source Software, 3(31), 1026, 
  https://doi.org/10.21105/joss.01026  

<!--
**<span style="color:#33a8ff">How to cite?</span>**

Bedre, R. (2018, October 22). ANOVA using Python. 
https://reneshbedre.github.io/blog/anova.html
-->

<span style="color:#9e9696">If you have any questions, comments or recommendations, please email me at 
<b>reneshbe@gmail.com</b></span>
    
<span style="color:#9e9696"><i> Last updated: October 24, 2020</i> </span>

<p>
{% include  subscribe.html %}
</p>

<p>
{% include  license.html %}
</p>